(function(e){"use strict";var t={};if(localStorage.chat){t=JSON.parse(localStorage.chat)}else{var n=(new Date).toISOString();t={created:n,updated:n,messages:[]}}t.load=function(n,a){var o=[];t.messages.slice(n||0,a).forEach(function(e,t){var n=e.sender;var a="<span>"+n.uid+" &lt;"+n.name+"&gt;</span>";var c="<span>"+e.sent.slice(0,19).replace("T"," ")+"</span>";var s="message-"+(t+1);var i='<div id="'+s+'" class="ui-offset-large">'+e.content+"</div>";o.push('<li><div class="ui-color-success">'+c+" &ensp;|&ensp; "+a+"</div>"+i+"</li>")});e("#chat-room").html(o.join("")).scrollTop(e("#chat-room").height());if(window.MathJax){MathJax.Hub.Queue(["Typeset",MathJax.Hub,"chat-room"])}};t.save=function(e){this.updated=(new Date).toISOString();this.messages.push(e);localStorage.chat=JSON.stringify(this)};t.export=function(){var e=JSON.stringify(this,null,"  ");window.open("data:application/json;charset=utf-8,"+encodeURIComponent(e))};t.encode=function(e){var t=Math.random().toString(36).slice(-2);return t+window.btoa(unescape(encodeURIComponent(e)))};t.decode=function(e){return decodeURIComponent(escape(window.atob(e.slice(2))))};t.display=function(t){var n=t.sender||{};var a="<span>"+n.uid+" &lt;"+n.name+"&gt;</span>";var o="<span>"+t.sent.slice(0,19).replace("T"," ")+"</span>";var c="message-"+(e("#chat-room > li").size()+1);var s='<div id="'+c+'" class="ui-offset-large">'+t.markup+"</div>";e("#chat-room").append('<li><div class="ui-color-success">'+o+" &ensp;|&ensp; "+a+"</div>"+s+"</li>").scrollTop(e("#chat-room").height());if(window.MathJax){MathJax.Hub.Queue(["Typeset",MathJax.Hub,c])}};t.list=function(t){var n="";var a=[];e("#user-list input:checked").each(function(){var t=e(this).next().text().match(/(\d+)\s+<(.+)>/)||[];a.push(t[1])});var o=a.length===0;t.forEach(function(e){var t=e.uid;var c=o||a.indexOf(t)!==-1?"checked ":"";var s="<span>"+t+" &lt;"+e.name+"&gt;</span>";var i='<a href="/users/'+t+'" target="_blank">'+s+"</a>";var r='<input type="checkbox" name="user-'+t+'" value="true" title="Checked to allow this user receive your messages" '+c+"/>";n+="<li>"+r+" "+i+"</li>"});e("#user-list").html(n);e("#user-list input").change()};t.connect=function(){var n=new WebSocket("ws://"+document.location.host);n.onopen=function(a){e("#chat-safe").prop("checked",false);n.send(t.encode(JSON.stringify({state:"open",joined:(new Date).toISOString()})));t.load(-10)};n.onmessage=function(e){var n=JSON.parse(t.decode(e.data));var a=n.state||"connected";if(a==="connected"){t.display(n);t.save(n)}else{t.list(n.users)}};n.onerror=function(e){setTimeout(function(){location.reload()},500)};e("#chat-close").on("click",function(){n.close();e("#user-list").empty()});e("#user-list").on("change","input",function(){var a=[];e("#user-list input:checked").each(function(){var t=e(this).next().text().match(/(\d+)\s+<(.+)>/)||[];a.push({uid:t[1],name:t[2]})});n.send(t.encode(JSON.stringify({state:"updated",receivers:a})))});e("#chat-safe").on("change",function(){n.send(t.encode(JSON.stringify({state:"updated",safe:e(this).prop("checked")})))});e("#chat-form").on("submit",function(){var a=e(this);var o=a.find("textarea");var c=o.val();if(c!==""){n.send(t.encode(JSON.stringify({sent:(new Date).toISOString(),content:c})));o.val("")}return false})};e(document).ready(function(){t.connect();e("#chat-view").on("click",function(){t.load()});e("#chat-clear").on("click",function(){e("#chat-room").empty()});e("#chat-export").on("click",function(){t.export()});e("#chat-delete").on("click",function(){localStorage.clear("chat");e("#chat-room").empty()});e("#chat-refresh").on("click",function(){location.reload()})})})(jQuery);