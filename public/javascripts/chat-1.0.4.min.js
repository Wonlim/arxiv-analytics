(function(e){"use strict";var t={};if(localStorage.chat){t=JSON.parse(localStorage.chat)}else{var n=(new Date).toISOString();t={created:n,updated:n,messages:[]}}t.load=function(n,a){var o=[];t.messages.slice(n||0,a).forEach(function(e,n){o.push(t.parse(e,n+1))});e("#chat-room").html(o.join("")).scrollTop(e("#chat-room").height());e(document).trigger("create.dom");if(window.MathJax){MathJax.Hub.Queue(["Typeset",MathJax.Hub,"chat-room"])}};t.parse=function(e,t){var n=e.sender;var a={id:t,uid:n.uid,name:n.name,markup:e.markup,date:e.sent.slice(0,19).replace("T"," ")};return schema.format('<li><div class="ui-color-success"><span>${date}</span> &ensp;|&ensp; <span>${uid} &lt;${name}&gt;</span></div><div id="message-${id}" class="ui-offset-large">${markup}</div></li>',a)};t.save=function(e){this.updated=(new Date).toISOString();this.messages.push(e);localStorage.chat=JSON.stringify(this)};t.export=function(){var e=JSON.stringify(this,null,2);window.open("data:application/json;charset=utf-8,"+encodeURIComponent(e))};t.encode=function(e){var t=Math.random().toString(36).slice(-2);return t+window.btoa(unescape(encodeURIComponent(e)))};t.decode=function(e){return decodeURIComponent(escape(window.atob(e.slice(2))))};t.notify=function(e,t){if(window.Notification){if(Notification.permission==="granted"){var n=new Notification(e,t);n.onshow=function(){setTimeout(n.close.bind(n),4e3)}}}};t.display=function(n){var a=e("#chat-room > li").size()+1;e("#chat-room").append(t.parse(n,a)).scrollTop(e("#chat-room").height());e(document).trigger("create.dom");if(window.MathJax){MathJax.Hub.Queue(["Typeset",MathJax.Hub,"message-"+a])}};t.list=function(t){var n="";var a=[];e("#user-list input:checked").each(function(){var t=e(this).next().text().match(/(\d+)\s+<(.+)>/)||[];a.push(t[1])});var o=a.length===0;t.forEach(function(e){var t={uid:e.uid,name:e.name,checked:o||a.indexOf(uid)!==-1?"checked ":""};n+=schema.format('<li><input type="checkbox" name="user-${uid}" value="true" title="Checked to allow this user receive your messages" ${checked}/> <a href="/users/${uid}" target="_blank"><span>${uid} &lt;${name}&gt;</span></a></li>',t)});e("#user-list").html(n);e("#user-list input").change()};t.connect=function(){var n=document.location.hostname;var a=document.location.port||"3000";var o=new WebSocket("ws://"+n+":"+a);o.onopen=function(n){e("#chat-safe").prop("checked",false);o.send(t.encode(JSON.stringify({state:"open",joined:(new Date).toISOString()})));t.load(-10);if(window.Notification&&Notification.permission==="default"){Notification.requestPermission()}};o.onmessage=function(e){var n=JSON.parse(t.decode(e.data));var a=n.state||"connected";if(a==="connected"){if(document.hidden){t.notify("You have a new chat message from arxitics!")}t.display(n);t.save(n)}else{t.list(n.users)}};o.onerror=function(e){setTimeout(function(){location.reload()},500)};e("#chat-close").on("click",function(){o.close();e("#user-list").empty()});e("#user-list").on("change","input",function(){var n=[];e("#user-list input:checked").each(function(){var t=e(this).next().text().match(/(\d+)\s+<(.+)>/)||[];n.push({uid:t[1],name:t[2]})});o.send(t.encode(JSON.stringify({state:"updated",receivers:n})))});e("#chat-safe").on("change",function(){o.send(t.encode(JSON.stringify({state:"updated",safe:e(this).prop("checked")})))});e("#chat-form").on("submit",function(){var n=e(this);var a=n.find("textarea");var i=a.val();if(i!==""){o.send(t.encode(JSON.stringify({sent:(new Date).toISOString(),content:i})));a.val("")}return false})};e(document).ready(function(){t.connect();e("#chat-view").on("click",function(){t.load()});e("#chat-clear").on("click",function(){e("#chat-room").empty()});e("#chat-export").on("click",function(){t.export()});e("#chat-delete").on("click",function(){localStorage.clear("chat");e("#chat-room").empty()});e("#chat-refresh").on("click",function(){location.reload()})})})(jQuery);